#!/usr/bin/env bash

set -euo pipefail

version="0.1.12"

if [[ ${CLOAD_DEBUG:-} ]]; then
  set -x
fi

help() {
  pod2text $0
  exit 1
}

version() {
  local _verbose=${1:-}
  if [[ $_verbose ]]; then
    echo "cload - version $version"
  else
    echo $version
  fi
  exit 0
}

load_shrc() {
  local _base=$1
  local _path=$2
  local _src=$(
    find $_path -maxdepth 1 \
      -name ${_base} -o -name ${_base}.sh -o -name ${_base}.shrc \
      | head -1
  )
  if [[ ${_src} ]]; then
    echo ". ${_src}"
    return
  fi
  return 1
}

case "$1" in
  "-h" | "--help" )
    help ;;
  "-v" )
    version ;;
  "--version" )
    version --verbose ;;
  * ) ;;
esac

shrc=$1
if [ -r $shrc ]; then
  echo ". $shrc"
  exit 0
fi
if [[ -z ${CLOAD_PATH:-} ]]; then
  echo "CLOAD_PATH not set. Can't load ${shrc}." >&2
  exit 1
fi
for srch in $(echo $CLOAD_PATH | tr ':' ' '); do
  load_shrc $shrc $srch && exit 0
done
echo "Can't load ${shrc}." >&2

exit 1

: <<'__EOF__'

=encoding utf8

=head1 NAME

B<cload> - Load shell resource from C<$CLOAD_PATH>

=head1 SYNOPSYS

    # Load 'foo' or 'foo.sh' or 'foo.shrc'
    eval "$(cload foo)"

=head1 DESCRIPTION

Print command to load specified shell resource file.
The file is searched from C<$CLOAD_PATH> which contains some directories in the
filesystem.

=head1 AUTHORS

YASUTAKE Kiyoshi E<lt>yasutake.kiyoshi@gmail.comE<gt>

=head1 LICENSE

The MIT License (MIT)

Copyright (c) 2016 YASUTAKE Kiyoshi

=cut

__EOF__

