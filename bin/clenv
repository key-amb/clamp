#!/usr/bin/env bash

set -euo pipefail

version="0.0.5"

help() {
  pod2text $0
  exit 1
}

init-env() {
  local env=${1:-${CLENV_ENVIRONMENT:-default}}
  local base_dir=${CLENV_ROOT:-$HOME/.clenv}
  local env_dir=${base_dir}/environments/${env}
  if [ -d $env_dir ]; then
    echo "'$env' already exists"
  else
    mkdir -p $env_dir/{bin,lib,modules}
    echo "Initialized env '$env'"
  fi
}

list-env() {
  local base_dir=${CLENV_ROOT:-$HOME/.clenv}
  local env
  for env in $(\ls -1 ${base_dir}/environments/); do
    local pref=" "
    if [[ $env = $CLENV_ENVIRONMENT ]]; then
      pref="*"
    fi
    echo "${pref} ${env}"
  done
}

use() {
  local env=${1:-default}
  local base_dir=${CLENV_ROOT:-$HOME/.clenv}
  local env_dir=${base_dir}/environments/${env}
  if [[ ! -d $env_dir ]]; then
    echo "'$env' don't exist!" >&2
    return 1
  fi

  echo "export CLENV_ENVIRONMENT=$env;"
  echo "
if [ -s ${base_dir}/shims ]; then
  rm -f ${base_dir}/shims;
fi;
ln -sf ${env_dir}/bin ${base_dir}/shims;
"
  lib_dir=${env_dir}/lib
  for rc in $(ls $lib_dir/); do
    echo "source $lib_dir/$rc;"
  done
}

version() {
  local _verbose=${1:-}
  if [[ $_verbose ]]; then
    echo "clenv - version $version"
  else
    echo $version
  fi
}

command=${1:-}

case "$command" in
  "" | "-h" | "--help" )
    help
    ;;
  "-v" )
    version
    ;;
  "--version" )
    version --verbose
    ;;
  * )
    shift
    ${command} "$@"
    ;;
esac

exit 0

: <<'__EOF__'

=encoding utf8

=head1 NAME

B<clenv> - CLI to control I<clenv> environments

=head1 SYNOPSYS

    clenv init-env $env
    clenv list-env

    eval $(clenv use $env)

Help:

    clenv -h|--help|help

Show version:

    clenv -v|--version|version

=head1 DESCRIPTION

TBD.

=head1 AUTHORS

YASUTAKE Kiyoshi E<lt>yasutake.kiyoshi@gmail.comE<gt>

=head1 LICENSE

The MIT License (MIT)

Copyright (c) 2016 YASUTAKE Kiyoshi

=cut

__EOF__

